name: GitAI-全自动生产线-V4升级版
on: 
  workflow_dispatch: 

jobs:
  ai_build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. AI 搬运源码
        uses: actions/checkout@v4 # 升级到 v4
        with:
          submodules: recursive

      - name: 2. AI 配置 Java 环境
        uses: actions/setup-java@v4 # 升级到 v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 3. AI 自动定位并注入密钥
        run: |
          # 全局搜索 Extra.java，无视版本差异
          TARGET=$(find . -name "Extra.java" | grep "nekogram" | head -n 1)
          if [ -z "$TARGET" ]; then
            echo "❌ AI 没找到图纸，请检查源码"
            exit 1
          fi
          sed -i "s/API_ID = 0/API_ID = ${{ secrets.MY_API_ID }}/g" $TARGET
          sed -i "s/API_HASH = null/API_HASH = \"${{ secrets.MY_API_HASH }}\"/g" $TARGET
          echo "✅ AI 注入密钥成功"

      - name: 4. AI 开启云端打包 (15-20分钟)
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon

      - name: 5. AI 上传成品 APK (已升级 v4)
        uses: actions/upload-artifact@v4 # 核心修复：这里必须用 v4
        with:
          name: My-Custom-App
          path: "**/build/outputs/apk/release/*.apk"
          compression-level: 9
